# 英语语料库系统配置说明

## 📋 系统架构概述

本系统采用nginx + Flask架构：
- **nginx**: 作为反向代理服务器，处理静态文件服务和API转发
- **Flask**: 作为后端应用服务器，提供RESTful API接口
- **Redis**: 数据缓存和存储
- **MySQL**: 语料库数据存储

## 🔧 配置文件详情

### 1. LaunchAgent 开机启动配置

**文件位置**: `/Users/learner/Library/LaunchAgents/com.user.english-corpus.plist`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.user.english-corpus</string>
    
    <key>ProgramArguments</key>
    <array>
        <string>/bin/bash</string>
        <string>-c</string>
        <string>
            # 启动nginx
            /usr/local/bin/nginx
            
            # 等待nginx启动
            sleep 3
            
            # 启动Flask应用
            cd /Users/learner/Desktop/data/english
            source venv/bin/activate
            nohup python3 app.py > flask_app.log 2>&1 &
        </string>
    </array>
    
    <key>RunAtLoad</key>
    <true/>
    
    <key>KeepAlive</key>
    <false/>
    
    <key>StandardOutPath</key>
    <string>/Users/learner/Desktop/data/english/launchd.log</string>
    
    <key>StandardErrorPath</key>
    <string>/Users/learner/Desktop/data/english/launchd-error.log</string>
    
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
    </dict>
    
    <key>WorkingDirectory</key>
    <string>/Users/learner/Desktop/data/english</string>
</dict>
</plist>
```

**管理命令**:
```bash
# 加载配置
launchctl load ~/Library/LaunchAgents/com.user.english-corpus.plist

# 卸载配置
launchctl unload ~/Library/LaunchAgents/com.user.english-corpus.plist

# 查看状态
launchctl list | grep english-corpus
```

### 2. nginx 配置

**主配置文件**: `/usr/local/etc/nginx/nginx.conf`
**虚拟主机配置**: `/usr/local/etc/nginx/vhosts/mycorpus.conf`

```nginx
server {
    listen       80;
    server_name  www.mycorpus.com;

    access_log  /usr/local/var/log/nginx/mycorpus.access.log;
    error_log   /usr/local/var/log/nginx/mycorpus.error.log;

    # 静态文件服务
    location / {
        root   /Users/learner/Desktop/data/english;
        index  index.html index.htm;
        autoindex on;
    }

    # 静态资源缓存配置
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        root   /Users/learner/Desktop/data/english;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # API请求代理到Flask应用
    location /api/ {
        proxy_pass http://127.0.0.1:5057;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**nginx管理命令**:
```bash
# 启动nginx
sudo nginx

# 重新加载配置
sudo nginx -s reload

# 停止nginx
sudo nginx -s stop
```

### 3. Flask 应用配置

**主文件**: `/Users/learner/Desktop/data/english/app.py`

主要功能模块：
- WebSocket通信 (SocketIO)
- Redis数据缓存
- MySQL语料库数据访问
- RESTful API接口

**启动方式**:
```bash
cd /Users/learner/Desktop/data/english
source venv/bin/activate
python3 app.py
```

**生产环境启动**:
```bash
cd /Users/learner/Desktop/data/english
source venv/bin/activate
nohup python3 app.py > flask_app.log 2>&1 &
```

## 🌐 网络配置

### 域名解析
本地hosts文件配置（`/etc/hosts`）:
```
127.0.0.1   www.mycorpus.com
```

### 服务端口
- **nginx**: 80 (HTTP)
- **Flask**: 5057 (应用端口)
- **Redis**: 6379 (默认)
- **MySQL**: 3306 (默认)

## 🔐 权限配置

### 目录权限要求
为确保nginx正常访问，需要以下目录权限：
```bash
# 用户目录权限
sudo chmod o+rx /Users/learner/
sudo chmod o+rx /Users/learner/Desktop/

# 项目目录权限
sudo chmod -R o+rx /Users/learner/Desktop/data/english/
```

### 文件权限检查
```bash
# 检查文件扩展属性
ls -la@ /Users/learner/Desktop/data/english/index.html

# 移除扩展属性
xattr -c /Users/learner/Desktop/data/english/index.html
```

## 📊 监控与日志

### 日志文件位置
- **nginx访问日志**: `/usr/local/var/log/nginx/mycorpus.access.log`
- **nginx错误日志**: `/usr/local/var/log/nginx/mycorpus.error.log`
- **Fl应用日志**: `/Users/learner/Desktop/data/english/flask_app.log`
- **启动服务日志**: `/Users/learner/Desktop/data/english/launchd.log`

### 服务监控
```bash
# 检查nginx状态
ps aux | grep nginx | grep -v grep

# 检查Flask应用状态
ps aux | grep "python.*app.py" | grep -v grep

# 测试服务访问
curl -I http://www.mycorpus.com
curl -I http://www.mycorpus.com/api/get_saved_data
```

## 🚀 部署流程

### 全新部署步骤
1. 安装nginx: `brew install nginx`
2. 配置nginx虚拟主机
3. 设置本地域名解析
4. 配置目录权限
5. 创建LaunchAgent开机启动配置
6. 加载LaunchAgent配置

### 日常维护命令
```bash
# 查看服务状态
launchctl list | grep english-corpus

# 重启服务
launchctl unload ~/Library/LaunchAgents/com.user.english-corpus.plist
launchctl load ~/Library/LaunchAgents/com.user.english-corpus.plist

# 查看日志
tail -f /usr/local/var/log/nginx/mycorpus.error.log
tail -f /Users/learner/Desktop/data/english/flask_app.log
```

## ⚠️ 故障排除

### 常见问题
1. **403 Forbidden错误**: 检查目录权限和文件扩展属性
2. **502 Bad Gateway错误**: 检查Flask应用是否运行
3. **连接拒绝错误**: 检查防火墙和端口配置

### 权限问题解决
```bash
# 递归设置目录权限
sudo chmod -R o+rx /Users/learner/Desktop/data/english/

# 检查并修复路径权限
ls -ld /Users/learner/ /Users/learner/Desktop/ /Users/learner/Desktop/data/ /Users/learner/Desktop/data/english/
```

---
*文档更新时间: 2025-09-13*
*系统版本: nginx/1.29.1, Flask/3.1.2*
